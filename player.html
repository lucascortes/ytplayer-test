<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>YouTube Player</title>

    <style>
        body { margin: 0; width: 100%; height: 100%; background-color: #000; }
        html { width: 100%; height: 100%; background-color: #000; }

        .embed-container iframe,
        .embed-container object,
        .embed-container embed {
            position: absolute;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
        }
    </style>
</head>
<body>
    <div class="embed-container">
        <div id="player"></div>
    </div>

    <!-- Load YouTube API -->
    <script src="https://www.youtube.com/iframe_api"
        onerror="window.location.href='ytplayer://onYouTubeIframeAPIFailedToLoad'">
    </script>

    <script>
    var player;
    var error = false;

    // --- NEW: Read the ?config= parameter sent from iOS ---
    function getConfigFromQuery() {
        const params = new URLSearchParams(window.location.search);
        const rawConfig = params.get("config");

        if (!rawConfig) {
            console.error("❌ No config parameter received");
            return null;
        }

        try {
            console.log("Config received (raw):", rawConfig);
            return JSON.parse(rawConfig);
        } catch (e) {
            console.error("❌ Failed to parse config:", e, rawConfig);
            return null;
        }
    }

    var playerConfig = null;

    // YouTube API ready → initialize player
    function onYouTubeIframeAPIReady() {
        playerConfig = getConfigFromQuery();

        if (!playerConfig) {
            console.error("❌ Missing or invalid player configuration.");
            return;
        }

        // Inject JS event bindings so callbacks from iOS actually work
        playerConfig.events = {
            'onReady': onReady,
            'onStateChange': onStateChange,
            'onPlaybackQualityChange': onPlaybackQualityChange,
            'onError': onPlayerError
        };

        console.log("Initializing YT player with config:", playerConfig);

        player = new YT.Player('player', playerConfig);
        player.setSize(window.innerWidth, window.innerHeight);

        window.location.href = 'ytplayer://onYouTubeIframeAPIReady';

        // notify play time while playing
        function getCurrentTime() {
            if (player && player.getPlayerState() === YT.PlayerState.PLAYING) {
                var time = player.getCurrentTime();
                window.location.href = 'ytplayer://onPlayTime?data=' + time;
            }
        }
        setInterval(getCurrentTime, 500);
    }

    // ---- Callbacks forwarded back to iOS ----

    function onReady(event) {
        window.location.href = 'ytplayer://onReady?data=' + event.data;
    }

    function onStateChange(event) {
        if (!error) {
            window.location.href = 'ytplayer://onStateChange?data=' + event.data;
        } else {
            error = false;
        }
    }

    function onPlaybackQualityChange(event) {
        window.location.href = 'ytplayer://onPlaybackQualityChange?data=' + event.data;
    }

    function onPlayerError(event) {
        if (event.data == 100) error = true;
        window.location.href = 'ytplayer://onError?data=' + event.data;
    }

    window.onresize = function() {
        if (player) player.setSize(window.innerWidth, window.innerHeight);
    };
    </script>
</body>
</html>
